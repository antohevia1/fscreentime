service: screen-time-api

useDotenv: true

custom:
  domainName: ${env:DOMAIN_NAME, 'fscreentime.app'}
  certificateArn: ${env:ACM_CERTIFICATE_ARN, ''}
  websiteBucket: ${self:service}-${sls:stage}-website

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  profile: ${env:AWS_PROFILE, 'other'}
  stage: ${opt:stage, 'dev'}
  memorySize: 256
  timeout: 10
  environment:
    DYNAMODB_GOALS_TABLE: ${self:service}-${sls:stage}-goals
    DYNAMODB_PAYMENTS_TABLE: ${self:service}-${sls:stage}-payments
    DATA_BUCKET: ${self:service}-${sls:stage}-data
    STRIPE_SECRET_KEY: ${env:STRIPE_SECRET_KEY, 'REPLACE_ME'}
    STRIPE_WEBHOOK_SECRET: ${env:STRIPE_WEBHOOK_SECRET, 'REPLACE_ME'}
    SES_REGION: ${env:SES_REGION, 'ap-southeast-2'}
    SES_FROM_EMAIL: ${env:SES_FROM_EMAIL, 'noreply@fscreentime.app'}
    SES_SUPPORT_EMAIL: ${env:SES_SUPPORT_EMAIL, 'ifundfocus@gmail.com'}
    APP_URL: ${env:APP_URL, 'https://www.fscreentime.app'}
    STAGE: ${sls:stage}
  httpApi:
    cors:
      allowedOrigins:
        - https://fscreentime.app
        - https://www.fscreentime.app
        - http://localhost:5173
      allowedMethods:
        - GET
        - POST
        - DELETE
        - OPTIONS
      allowedHeaders:
        - Content-Type
        - Authorization
        - x-api-key
    throttle:
      burstLimit: 10
      rateLimit: 20
    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: !Sub 'https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}'
        audience:
          - !Ref CognitoUserPoolClient
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - !GetAtt GoalsTable.Arn
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - !GetAtt PaymentsTable.Arn
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - !Sub 'arn:aws:s3:::${self:provider.environment.DATA_BUCKET}/*'
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - !Sub 'arn:aws:s3:::${self:provider.environment.DATA_BUCKET}'
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'

functions:
  # Public endpoint — phone devices post screen time here
  ingest:
    handler: handler.ingest
    events:
      - httpApi:
          path: /ingest
          method: post
    environment:
      API_KEY: ${env:INGEST_API_KEY, 'REPLACE_ME'}

  ingestBulk:
    handler: handler.ingestBulk
    timeout: 30
    events:
      - httpApi:
          path: /ingest/bulk
          method: post
    environment:
      API_KEY: ${env:INGEST_API_KEY, 'REPLACE_ME'}

  # Authenticated endpoints (goals only — data reads go direct to S3)
  saveGoal:
    handler: handler.saveGoal
    events:
      - httpApi:
          path: /goals
          method: post
          authorizer:
            name: cognitoAuthorizer

  getGoal:
    handler: handler.getGoal
    events:
      - httpApi:
          path: /goals
          method: get
          authorizer:
            name: cognitoAuthorizer

  getGoalHistory:
    handler: handler.getGoalHistory
    events:
      - httpApi:
          path: /goals/history
          method: get
          authorizer:
            name: cognitoAuthorizer

  deleteAccount:
    handler: handler.deleteAccount
    timeout: 30
    events:
      - httpApi:
          path: /delete-account
          method: post
          authorizer:
            name: cognitoAuthorizer

  # ── Stripe payment endpoints ──────────────────────────────
  getPaymentMethod:
    handler: stripe.getPaymentMethod
    events:
      - httpApi:
          path: /payment-method
          method: get
          authorizer:
            name: cognitoAuthorizer

  updatePaymentMethod:
    handler: stripe.updatePaymentMethod
    events:
      - httpApi:
          path: /update-payment-method
          method: post
          authorizer:
            name: cognitoAuthorizer

  createSetupIntent:
    handler: stripe.createSetupIntent
    events:
      - httpApi:
          path: /create-setup-intent
          method: post
          authorizer:
            name: cognitoAuthorizer

  cancelGoal:
    handler: stripe.cancelGoal
    events:
      - httpApi:
          path: /goals/cancel
          method: post
          authorizer:
            name: cognitoAuthorizer

  cancelRenewal:
    handler: stripe.cancelRenewal
    events:
      - httpApi:
          path: /goals/cancel-renewal
          method: post
          authorizer:
            name: cognitoAuthorizer

  stripeWebhook:
    handler: stripe.stripeWebhook
    events:
      - httpApi:
          path: /stripe-webhook
          method: post

  # ── Contact / Feedback ────────────────────────────────────
  submitFeedback:
    handler: contact.submitFeedback
    events:
      - httpApi:
          path: /contact
          method: post

  # Penalty processor — runs hourly on Sun+Mon to cover all timezones.
  # Only processes a goal when it is Monday 9 AM in the customer's local time.
  processPenalties:
    handler: stripe.processPenalties
    timeout: 120
    events:
      - schedule:
          rate: cron(0 * ? * SUN-TUE *)
          enabled: true

resources:
  Conditions:
    IsProduction:
      !Equals ['${sls:stage}', 'prod']

  Resources:
    # ── Cognito User Pool ────────────────────────────────────
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      DeletionPolicy: Retain
      Properties:
        UserPoolName: ${self:service}-${sls:stage}-users
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Schema:
          - Name: email
            Required: true
            Mutable: true
          - Name: preferred_username
            Required: false
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: false
            RequireLowercase: false
            RequireNumbers: false
            RequireSymbols: false
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1

    CognitoUserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      Properties:
        Domain: ${self:service}-${sls:stage}-${env:COGNITO_DOMAIN_SUFFIX, 'app'}
        UserPoolId: !Ref CognitoUserPool

    GoogleIdentityProvider:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId: !Ref CognitoUserPool
        ProviderName: Google
        ProviderType: Google
        ProviderDetails:
          client_id: ${env:GOOGLE_CLIENT_ID, 'REPLACE_ME'}
          client_secret: ${env:GOOGLE_CLIENT_SECRET, 'REPLACE_ME'}
          authorize_scopes: 'openid email profile'
        AttributeMapping:
          email: email
          username: sub
          preferred_username: name

    FacebookIdentityProvider:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId: !Ref CognitoUserPool
        ProviderName: Facebook
        ProviderType: Facebook
        ProviderDetails:
          client_id: ${env:FACEBOOK_APP_ID, 'REPLACE_ME'}
          client_secret: ${env:FACEBOOK_APP_SECRET, 'REPLACE_ME'}
          authorize_scopes: 'public_profile,email'
        AttributeMapping:
          email: email
          username: id
          preferred_username: name

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      DependsOn:
        - GoogleIdentityProvider
        - FacebookIdentityProvider
      Properties:
        ClientName: ${self:service}-${sls:stage}-client
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_SRP_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        SupportedIdentityProviders:
          - COGNITO
          - Google
          - Facebook
        AllowedOAuthFlows:
          - code
        AllowedOAuthScopes:
          - openid
          - email
          - profile
        AllowedOAuthFlowsUserPoolClient: true
        CallbackURLs:
          - http://localhost:5173/app
          - https://www.fscreentime.app/app
          - https://fscreentime.app/app
        LogoutURLs:
          - http://localhost:5173/
          - https://www.fscreentime.app/
          - https://fscreentime.app/

    # ── Cognito Identity Pool (for direct S3 access) ────────
    CognitoIdentityPool:
      Type: AWS::Cognito::IdentityPool
      DeletionPolicy: Retain
      Properties:
        IdentityPoolName: ${self:service}-${sls:stage}-identity
        AllowUnauthenticatedIdentities: false
        CognitoIdentityProviders:
          - ClientId: !Ref CognitoUserPoolClient
            ProviderName: !GetAtt CognitoUserPool.ProviderName

    CognitoIdentityPoolRoleAttachment:
      Type: AWS::Cognito::IdentityPoolRoleAttachment
      Properties:
        IdentityPoolId: !Ref CognitoIdentityPool
        Roles:
          authenticated: !GetAtt CognitoAuthRole.Arn

    CognitoAuthRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Federated: cognito-identity.amazonaws.com
              Action: sts:AssumeRoleWithWebIdentity
              Condition:
                StringEquals:
                  'cognito-identity.amazonaws.com:aud': !Ref CognitoIdentityPool
                'ForAnyValue:StringLike':
                  'cognito-identity.amazonaws.com:amr': authenticated
        Policies:
          - PolicyName: CognitoS3Access
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                # Users can only list objects under their own prefix
                - Effect: Allow
                  Action:
                    - s3:ListBucket
                  Resource:
                    - !Sub 'arn:aws:s3:::${self:provider.environment.DATA_BUCKET}'
                  Condition:
                    StringLike:
                      's3:prefix':
                        - !Sub '${!cognito-identity.amazonaws.com:sub}/*'
                # Users can only read objects under their own prefix
                - Effect: Allow
                  Action:
                    - s3:GetObject
                  Resource:
                    - !Sub 'arn:aws:s3:::${self:provider.environment.DATA_BUCKET}/${!cognito-identity.amazonaws.com:sub}/*'

    # ── DynamoDB ─────────────────────────────────────────────
    GoalsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_GOALS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: weekStart
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: weekStart
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    PaymentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_PAYMENTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH

    # ── S3 (screen time data, partitioned per user) ──────────
    DataBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.DATA_BUCKET}
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - HEAD
              AllowedHeaders:
                - '*'
              MaxAge: 3600

    # ── Frontend Hosting (prod only) ─────────────────────────
    WebsiteBucket:
      Type: AWS::S3::Bucket
      Condition: IsProduction
      Properties:
        BucketName: ${self:custom.websiteBucket}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    CloudFrontOAC:
      Type: AWS::CloudFront::OriginAccessControl
      Condition: IsProduction
      Properties:
        OriginAccessControlConfig:
          Name: ${self:service}-${sls:stage}-oac
          OriginAccessControlOriginType: s3
          SigningBehavior: always
          SigningProtocol: sigv4

    WebsiteBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Condition: IsProduction
      Properties:
        Bucket: !Ref WebsiteBucket
        PolicyDocument:
          Statement:
            - Sid: AllowCloudFrontServicePrincipal
              Effect: Allow
              Principal:
                Service: cloudfront.amazonaws.com
              Action: s3:GetObject
              Resource: !Sub '${WebsiteBucket.Arn}/*'
              Condition:
                StringEquals:
                  'AWS:SourceArn': !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

    SecurityHeadersPolicy:
      Type: AWS::CloudFront::ResponseHeadersPolicy
      Condition: IsProduction
      Properties:
        ResponseHeadersPolicyConfig:
          Name: ${self:service}-${sls:stage}-security-headers
          SecurityHeadersConfig:
            StrictTransportSecurity:
              AccessControlMaxAgeSec: 63072000
              IncludeSubdomains: true
              Preload: true
              Override: true
            ContentTypeOptions:
              Override: true
            FrameOptions:
              FrameOption: DENY
              Override: true
            ReferrerPolicy:
              ReferrerPolicy: strict-origin-when-cross-origin
              Override: true
            XSSProtection:
              ModeBlock: true
              Protection: true
              Override: true
            ContentSecurityPolicy:
              ContentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://www.googletagmanager.com; font-src 'self' data:; connect-src 'self' https://*.execute-api.us-east-1.amazonaws.com https://*.amazonaws.com https://*.amazoncognito.com https://cognito-idp.us-east-1.amazonaws.com https://cognito-identity.us-east-1.amazonaws.com https://www.google-analytics.com https://api.stripe.com; frame-src https://js.stripe.com https://*.amazoncognito.com; object-src 'none'; base-uri 'self'; form-action 'self' https://*.amazoncognito.com"
              Override: true

    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Condition: IsProduction
      Properties:
        DistributionConfig:
          Aliases:
            - ${self:custom.domainName}
            - www.${self:custom.domainName}
          ViewerCertificate:
            AcmCertificateArn: ${self:custom.certificateArn}
            MinimumProtocolVersion: TLSv1.2_2021
            SslSupportMethod: sni-only
          DefaultCacheBehavior:
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
          Origins:
            - Id: S3Origin
              DomainName: !GetAtt WebsiteBucket.RegionalDomainName
              OriginAccessControlId: !GetAtt CloudFrontOAC.Id
              S3OriginConfig:
                OriginAccessIdentity: ''
          DefaultRootObject: index.html
          CustomErrorResponses:
            - ErrorCode: 403
              ResponsePagePath: /index.html
              ResponseCode: 200
              ErrorCachingMinTTL: 0
            - ErrorCode: 404
              ResponsePagePath: /index.html
              ResponseCode: 200
              ErrorCachingMinTTL: 0
          Enabled: true
          HttpVersion: http2and3
          PriceClass: PriceClass_100

  Outputs:
    ApiEndpoint:
      Description: HTTP API endpoint
      Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
    UserPoolId:
      Description: Cognito User Pool ID
      Value: !Ref CognitoUserPool
    UserPoolClientId:
      Description: Cognito User Pool Client ID
      Value: !Ref CognitoUserPoolClient
    IdentityPoolId:
      Description: Cognito Identity Pool ID
      Value: !Ref CognitoIdentityPool
    CognitoDomain:
      Description: Cognito hosted UI domain
      Value: !Sub '${self:service}-${sls:stage}-${env:COGNITO_DOMAIN_SUFFIX, "app"}.auth.${AWS::Region}.amazoncognito.com'
    DataBucketName:
      Description: S3 bucket for screen time data
      Value: !Ref DataBucket
    WebsiteBucketName:
      Condition: IsProduction
      Description: S3 bucket for website hosting
      Value: !Ref WebsiteBucket
    CloudFrontDistributionId:
      Condition: IsProduction
      Description: CloudFront distribution ID
      Value: !Ref CloudFrontDistribution
    CloudFrontDomainName:
      Condition: IsProduction
      Description: CloudFront domain name
      Value: !GetAtt CloudFrontDistribution.DomainName

plugins:
  - serverless-offline
